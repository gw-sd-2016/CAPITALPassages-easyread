@import play.api.libs.json.Json
@import scala.reflect.runtime.universe._

@(form: Form[formdata.SimplePassageData], passageId: Long)

@main("Edit a  Passage") {


    <style type="text/css">
    /*This entire example and the sliders are from  https://github.com/eduardomb/jquery-panelslider */
    .panel {
    display: none ;
    width: 20% ;
    overflow-y: scroll ;
    overflow-x:scroll ;
    padding: 20px ;
    background-color: #333 ;
    color: #fff ;
    box-shadow: inset 0 0 5px 5px #222 ;
    }
    </style>

    <div id="left-panel" class="panel"></div>


    <div class="pull-right">


        <div class="btn-group">
            <h5>Choose The Grade Level this passage should be edited at</h5>
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">

                    Grade

                    @PassageAnalysisController.displayGrade(SimplePassage.byId(passageId).grade)

                    <span class="caret"></span></button>
                <ul class="dropdown-menu">
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=0">K</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=1">1</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=2">2</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=3">3</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=4">4</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=5">5</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=6">6</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=7">7</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=8">8</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=9">9</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=10">10</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=11">11</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=12">12</a></li>
                    <li><a href="editPassageAtGrade?passageId=@passageId&grade=13">College</a></li>
                </ul>
            </div>


        </div>

        </div>

        <a id="left-panel-link" class="btn btn-primary" href="#left-panel" style="display: none ;">
            <i class="glyphicon glyphicon-edit"> Left Panel</i>
        </a>


        @helper.form(routes.SimplePassageController.edit_submit(passageId)) {

                <!-- Left panel -->



            <div>
                <div class="box">
                    <div class="box-header">
                        <i class="icon-plus"></i>
                        <i class="icon-user icon-large"></i>
                        <h5>Edit an existing Passage</h5>
                    </div>
                    <div class="box-content box-table" style="padding: 10px ;">
                        @if(form.hasGlobalErrors) {
                            <div class="alert alert-danger">
                            @form.globalError.message

                            </div>
                        }
                        <p>


                            <strong>
                                This page shows Suggestions to make this passage readable for a @if(SimplePassage.byId(passageId).grade == 0) { Kindergarten } @if(SimplePassage.byId(passageId).grade >= 12) { College Level } else {
                                @if(SimplePassage.byId(passageId).grade > 0) { Grade @SimplePassage.byId(passageId).grade}
                            }reader</strong>

                    <h4>Title</h4>
                        <input type="text" name="passageTitle" placeholder="Passage Title" value="@form("passageTitle").value">

                        <h4>Source</h4>
                        <input type="text" name="source" placeholder="Passage Source" value="@form("source").value">

                        <input type="text" id="text" name="passageText" value="" style="display:none">

                        <input type="text" id="html" name="passageHTML" value='' style="display:none">

                    </div>
                        <br>
                        <br>


                        <h4>Passage Body</h4>
                            <!-- http://quilljs.com/docs/quickstart/ -->
                            <!-- Create the editor container -->

                        <a class="btn btn-primary" onClick="fetchSuggestions();">Load Suggestions</a>




                            <div id="editor">
                            </div>




                <button type="submit" class="btn btn-success">
                    <i class="btn-icon-only icon-check"></i> Submit
                </button>


                <br>
                <br>

                </div>
            </div>
        }
        <script src="/assets/js/jquery.panelslider.min.js"></script>
        <script>
                $('#left-panel-link').panelslider({side: 'left', clickClose: false, duration: 200 });
                $('#right-panel-link').panelslider({side: 'right', clickClose: false, duration: 200 });

                $('#close-panel-bt').click(function() {
                    $.panelslider.close();
                    document.body.style.display = 'none';
                    document.body.style.display = '';
                });
        </script>


        <script type="text/javascript" src="@routes.Application.javascriptRoutes()"></script>
        <script type="text/javascript" src='@routes.Assets.at("/javascripts/easyread.js")'></script>



            <!-- http://quilljs.com/docs/api -->
            <!-- Include the Quill library -->
        <script src="//cdn.quilljs.com/0.20.1/quill.js"></script>

            <!-- Initialize Quill editor -->
        <script>

                var configs = {
                    readOnly: false,
                    theme: 'snow',
                    styles: {
                        '.ql-editor' : {
                            'word-wrap': 'break-word',
                            'word-spacing': 'normal',
                            'text-align': 'left',
                            'line-height': '250%',
                            'width': '60%',
                            'font-size': '24'
                        }

                    },
                    formats: ['size', 'underline']
                };



                var quill = new Quill('#editor', configs);

                @if(SimplePassage.byId(passageId).html != null){
                    quill.setHTML('@Html(SimplePassage.byId(passageId).html)');
                } else {
                    //http://stackoverflow.com/questions/9913971/scala-how-can-i-get-an-escaped-representation-of-a-string
                    quill.setText(@Html(Literal(Constant(SimplePassage.byId(passageId).text)).toString));
                }

                quill.on('text-change', function(delta, source) {
                   // quill.formatText(0, quill.getText().length, "size", 20);
                    console.log("Called");
                    var element = document.getElementsByName("passageText")[0];


                    element.setAttribute("value", quill.getText());

                    var hEl = document.getElementsByName("passageHTML")[0];
                    hEl.setAttribute("value", quill.getHTML());
                });


                quill.on('selection-change', function(range) {
                    if (range) {
                        if (range.start == range.end) {
                            console.log('User cursor is on', range.start);
                        } else {
                            var text = quill.getText(range.start, range.end);
                            console.log('User has highlighted', text);

                            var string = text;


                            jsRoutes.controllers.SimplePassageController.getSuggestions(string).ajax({
                                success : function(data) {
                                    //window.location.reload();
                                    if(data.length > 0){


                                        var leftPanel = document.getElementById("left-panel");


                                        if(window.getComputedStyle(leftPanel).display === 'none'){
                                            console.log("doing this");

                                            $("#left-panel-link").click();

                                        }


                                        var upperDiv = '<div id="title"><h1>' + string + '</h1></div>';
                                        var approvalDiv = "<div id='accept'><button class='btn btn-primary' onclick='acceptWord(" + string + ");'>This is okay!</button></div><br>";

                                        var synonymnDiv = "<div class='container-fluid'> <div id='list'>";

                                        if(document.getElementById(string) == null){
                                            synonymnDiv += "This word is too complicated, <br> but we don't have any suggestions for you yet.";
                                        } else {
                                            //http://stackoverflow.com/questions/14572413/remove-line-breaks-from-start-and-end-of-string
                                            //http://stackoverflow.com/questions/22036576/why-does-the-javascript-string-whitespace-character-nbsp-not-match
                                            var synonymnList = document.getElementById(string).innerText.trim("/\r?\n|\r/g").split(String.fromCharCode(160));


                                            var ran = false;
                                            for(var i = 1; i < synonymnList.length; i++){
                                                ran = true;
                                                synonymnDiv += i + ". <span onclick='replaceWord(\"" + string + "\", \"" + synonymnList[i] + "\");' style='background-color: gray;'><h3>" + synonymnList[i] + "</h3></span><br>";
                                            }

                                            if(!ran){
                                                synonymnDiv += "This word is too complicated, <br> but we don't have any suggestions for you yet.";
                                            }


                                        }

                                        synonymnDiv += "</div></div><br><button id='close-panel-bt' class='btn btn-primary' onclick='$.panelslider.close();'>Close Planel</button>";

                                        leftPanel.innerHTML = upperDiv + approvalDiv + synonymnDiv;
                                    }
                                },
                                error : function(err) {
                                    //window.location = "";
                                },
                                complete : function() {

                                }
                            });


                        }
                    } else {
                        console.log('Cursor not in the editor');
                    }
                });

                function fetchSuggestions(){
                    underlineSpecificWords(@Html(Json.stringify(Json.toJson(SimplePassage.byId(passageId).text.split(" ").toList.distinct.filter(p => (Word.byLemma(p) != null && Word.byLemma(p).ageOfAcquisition > (SimplePassage.byId(passageId).grade + 6) && !SimplePassage.byId(passageId).getStopWords().contains(p)))))));
                }

                function underlineSpecificWords(words){

                    var text = quill.getText();

                    for(var i = 0; i < words.length; i++){
                        var currentText = text;
                        var word = words[i];
                        var index = text.indexOf(word);

                        while(index != -1){
                            console.log(index);
                            var offset = text.length - currentText.length;
                            quill.formatText(index + offset, index + offset + word.length, 'underline', true);
                            currentText = currentText.substring(index + word.length);
                            index = currentText.indexOf(word);
                        }
                    }

                    quill.formatText(0, quill.getText().length, "size", 20);
                }
        </script>

}